#!/usr/bin/sh

set -e

tmp=true
random=false
lock=false
dry=false
write=false
file=''

case $1 in
  '--help'|'-h')
    echo "Usage:       wpset [OPTIONS...] [FILE]"
    echo "Description: Sets or tests FILE as the current wallpaper. Unless
  \`-t' is given, it will echo the path of the wallpaper in /tmp/.wp. If \`-l' is
  given, it'll link the path to ~/.wp, which is restorable by \`-r'"
    echo "Options:
  -t: don't set TMP
  -k: dry: don't call FEH
  -w: write (link) source image
  -l: lock (link to HOME)
  -r: FILE from ~/.wp
  -R: FILE from /tmp/.wp
  -d: FILE from random in directory (FILE)"
    exit 0;;
esac

for arg in $@; do
  case $arg in
    '-t') tmp=false ;;
    '-d') random=true ;;
    '-l') lock=true ;;
    '-k') dry=true ;;
    '-w') write=true ;;
    '-r') file=~/.wp ;;
    '-R') file="$(cat /tmp/.wp 2>/dev/null)" ;;
    *) file=$arg ;;
  esac
done

if [[ -z $file ]]; then
  echo "[ !! ] Missing file. See \`--help'"
  exit 1
fi

if $random; then
  file="$(find "$file" -type f | shuf -n1)"
fi

file="$(realpath "$file")"

if $tmp; then
  echo "$file" > /tmp/.wp
fi

if $lock; then
  ln -svnf "$file" ~/.wp
fi

if $write; then
  ln -svnf "$file" /tmp/.wp.img
fi

if ! $dry; then
  feh --bg-scale --no-fehbg "$file"
fi
