#!/usr/bin/bash

## Xsession counterpart for the TTY

SESSION=zsh

# used for the emacs server to set itself up for a TTYsession
export WM="$1"
export XSESSION="$2"
export TERM=linux

mkdir -pv /tmp/emacs
touch /tmp/emacs/daemon.log

# this will fail if emacs has an existing session
case $WM in
  'tty'|'tmux')
    emacss start >> /tmp/emacs/daemon.log 2>&1 &&  \
      sleep 1 && docs journal >> /tmp/emacs/daemon.log 2>&1

    if [[ $XSESSION == "1" ]]; then
      # locked: ignore launching `linux.sh'
      if [[ ! -f /tmp/xsession.lock ]]; then
        touch /tmp/xsession.lock

        echo "[ == ] Starting XSESSION (TTYSESSION)"
        sleep 1

        export XINITSLEEP='/home/mh/Scripts/system/linux.sh'
        tmux new $SHELL

        if [[ $WM == 'tmux' ]]; then
          unset XINITSLEEP
          SESSION=tmux
          echo "[ .. ] Setting environment for tmux TTYsession"
          sleep 1
        fi
      elif [[ $WM == 'tmux' ]]; then
        unset XINITSLEEP
        SESSION=tmux
        echo "[ .. ] Setting environment for tmux TTYsession"
        sleep 1
      fi
    elif [[ $WM == 'tmux' ]]; then
      unset XINITSLEEP
      SESSION=tmux
      echo "[ .. ] Setting environment for tmux TTYsession"
      sleep 1
    fi ;;

  # we don't start the server when running `emacs-tty'
  'emacs-tty')
    SESSION=emacs
    if [[ $XSESSION == "1" ]]; then
      export XINITSLEEP='/home/mh/Scripts/system/linux.sh'
    else
      unset XINITSLEEP
    fi;;
esac

exec $SESSION
