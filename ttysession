#!/usr/bin/bash

## Xsession counterpart for the TTY

SHELL=zsh

# used for the emacs server to set itself up for a TTYsession
export WM="$1"
export XSESSION="$2"

mkdir -pv /tmp/emacs
touch /tmp/emacs/daemon.log

# this will fail if emacs has an existing session
case $WM in
  'tty')
    emacss start >> /tmp/emacs/daemon.log 2>&1 &&  \
      sleep 1 && docs journal >> /tmp/emacs/daemon.log 2>&1

    if [[ $XSESSION == "1" ]]; then
      # locked: ignore launching `linux.sh'
      if [[ -f /tmp/xsession.lock ]]; then
        exit 0
      else
        touch /tmp/xsession.lock

        echo "[ == ] Starting XSESSION (TTYSESSION)"
        sleep 3

        export XINITSLEEP='/home/mh/Scripts/system/linux.sh'
        tmux new $SHELL
      fi
    fi ;;
  # we don't start the server when running `emacs-tty'
  'emacs-tty')
    SHELL=emacs
    if [[ $XSESSION == "1" ]]; then
      export XINITSLEEP='/home/mh/Scripts/system/linux.sh'
    fi;;
esac

exec $SHELL
