#!/bin/sh

TERM=st
SUDO=doas
SHUTDOWN='poweroff now'
REBOOT='reboot now'
NOTIFY=herbe

AS=${0##*/}
AS=${AS/rc/}
ARG=

if [[ -d /tmp/pacman ]]
then
	if [[ -f /tmp/pacman/lock-pacman ]]
	then
		$NOTIFY "Package lock found" "found package lock set by \`linux.sh'. Wait to shutdown" &
		ARG=p
	fi

	if [[ -f /tmp/pacman/lock-pacman-artix ]]
	then
		$NOTIFY "Package lock found (subsystem)" "also found lock for \`artix'" &
		ARG="${ARG}a"
	fi

	if [[ -f /tmp/pacman/lock-paru ]]
	then
		$NOTIFY "Package lock found (subsystem)" "also found lock for \`paru'" &
		ARG="${ARG}n"
	fi

	if [[ -f /tmp/pacman/lock-efistub ]]
	then
		$NOTIFY "Efistub lock found" "found efistub lock set by \`linux.sh'. Wait to shutdown" &
		ARG="${ARG}e"
	fi
fi

if [[ -d /tmp/cron ]]
then
	if [[ ! -z $(/bin/find /tmp/cron -name '*.sh') ]]
	then
		$NOTIFY "Cron-like job found (script)" "Cron-like lock set by \`linux.sh'. Wait to shutdown" &
		ARG="${ARG}c"

	elif [[ ! -z $(/bin/find /tmp/cron -type f) ]]
	then
		$NOTIFY "Cron-like job found" "Cron-like lock set by \`linux.sh'. Wait to shutdown" &
		ARG="${ARG}d"
	fi
fi

# kill `emacsserver'
emacsserver stop

if [[ ! -z $ARG ]]
then
  printf '\a' > /dev/tty${DISPLAY:1:1}
	sleep 5
	export XINITSLEEP="/home/mh/Scripts/system/lock.sh"
	export XINITSLEEPARGS="${ARG}:${AS}"
	exec $TERM -e zsh # ACPI event is handled in the `XINITSLEEP' script
else
	case $AS in
		'shutdown')
			$SUDO $SHUTDOWN;;
		'reboot')
			$SUDO $REBOOT;;
		*) # fallback
			$SUDO $SHUTDOWN;;
	esac
fi
