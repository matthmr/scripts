#!/usr/bin/bash

SUDO=doas
NOTIFY=herbe

AS=${0##*/}
AS=${AS/rc/}
ARG=

# called by sxhkd
if [[ $1 == '-x' ]]; then
  $NOTIFY "Prompting user for checkout on the journal" &
  docs -x journal

  TERM=st
else
  NOTIFY='echo' # stub
  $NOTIFY "Prompting user for checkout on the journal" &
  docs journal
fi

if [[ -d /tmp/pacman ]]
then
	if [[ -f /tmp/pacman/lock-pacman ]]
	then
		$NOTIFY "Package lock found" "found package lock set by \`linux.sh'. Wait to shutdown" &
		ARG=p
	fi

	if [[ -f /tmp/pacman/lock-paru ]]
	then
		$NOTIFY "Package lock found (subsystem)" "also found lock for \`paru'" &
		ARG="${ARG}n"
	fi

	if [[ -f /tmp/pacman/lock-efistub ]]
	then
		$NOTIFY "Efistub lock found" "found efistub lock set by \`linux.sh'. Wait to shutdown" &
		ARG="${ARG}e"
	fi
fi

if [[ -d /tmp/cron ]]
then
	if [[ ! -z $(/bin/find /tmp/cron -name '*.sh') ]]
	then
		$NOTIFY "Cron-like job found (script)" "Cron-like lock set by \`linux.sh'. Wait to shutdown" &
		ARG="${ARG}c"

	elif [[ ! -z $(/bin/find /tmp/cron -type f) ]]
	then
		$NOTIFY "Cron-like job found" "Cron-like lock set by \`linux.sh'. Wait to shutdown" &
		ARG="${ARG}d"
	fi
fi

emacss stop

$NOTIFY "Preparing to send ACPI event..."
if [[ $1 == '-x' ]]; then
  printf '\a' > /dev/tty${DISPLAY:1:1}
else
  printf '\a' > /dev/tty1 # imagine...
fi

sleep 1

export XINITSLEEP="/home/mh/Scripts/system/lock.sh"
export XINITSLEEPARGS="${ARG}:${AS}"
if [[ $1 == '-x' ]]; then
  exec $TERM -e zsh # ACPI event is handled in the `XINITSLEEP' script
else
  export NOTIFY
  NOTIFY=echo $XINITSLEEP $XINITSLEEPARGS
fi
