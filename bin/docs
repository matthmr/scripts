#!/usr/bin/bash

function usage {
  echo "Usage:       docs [wiki|journal|project] [-p project] [-e editor] [-c command...]"
  echo "Description: Writes documentation on local document repositories"
  echo "Commands:
  on \`wiki': <path>
  on \`journal': <yy><mm>"
  exit 1
}

WIKI="/home/mh/Documents/Org/Wiki"
JOURNAL="/home/mh/Documents/Org/Journal"
PROJECT="/home/mh/Git/MH"

REPO=''
EDITOR=''

case $1 in
  '-h'|'--help')
    usage;;
esac

[[ -z $1 ]] && usage

function do_defaults {
  [[ -z $EDITOR ]] && EDITOR=emacsxc
  [[ -z $REPO ]]   && REPO=$WIKI/index.org
}

function wikicmd {
  REPO+="/$1.org"
}

function projectcmd {
  REPO+="/$1.org"
}

function journalcmd {
  local yy= mm=

  while :; do
    if (( ${#1} != 4 )); then
      break
    fi

    yy=${1:0:2}
    mm=${1:2:2}

    [[ -d $REPO/20$yy/ ]]        || break
    [[ -f $REPO/20$yy/$mm.org ]] || break

    REPO+="/20$yy/$mm.org"

    return 0
  done

  echo "[ !! ] Command doesn't evaluate"
  exit 1
}

function handle {
  local repo=$1

  case $repo in
    'wiki')
      REPO=$WIKI;;
    'journal')
      REPO=$JOURNAL;;
    'project')
      REPO=$PROJECT;;
  esac

  local _editor=false      \
        _cmd=false         \
        _project=false     \
        _did_cmd=false     \
        _did_project=false

  for opt in ${@:1}; do
    if [[ $opt = '-c' ]]; then
      _cmd=true
      _editor=false
      _project=false
      continue
    elif [[ $opt = '-p' ]]; then
      _cmd=false
      _project=true
      continue
    elif [[ $opt = '-e' ]]; then
      _cmd=false
      _project=false
      _editor=true
      continue
    fi

    if $_editor; then
      EDITOR+=" $opt"
    elif $_project; then
      REPO+="/$opt/dev"
      _did_project=true
    elif $_cmd; then
      local cmd=$opt
      case $repo in
        'wiki')
          _did_cmd=true
          wikicmd $cmd;;
        'journal')
          _did_cmd=true
          journalcmd $cmd;;
        'project')
          _did_cmd=true
          projectcmd $cmd;;
      esac
    fi
  done

  if [[ $repo = 'project' ]] && ! $_did_project; then
    echo "[ !! ] Missing project"
    exit 1
  fi

  if ! $_did_cmd; then
    REPO+="/index.org"
  fi
}

case $1 in
  'wiki')
    handle ${@:1};;
  'journal')
    handle ${@:1};;
  'project')
    handle ${@:1};;
  *)
    echo "[ !! ] Invalid entry"
    exit 1;;
esac

do_defaults

exec $EDITOR $REPO
