#!/usr/bin/bash

function usage {
  echo "Usage:       docs [wiki|journal] [-e editor] [-c command...]"
  echo "Description: Writes documentation on local document repositories"
  echo "Commands:
  on \`wiki': <path>
  on \`journal': <yy><mm>"
  exit 1
}

WIKI=/home/mh/Documents/Org/Wiki
JOURNAL=/home/mh/Documents/Org/Journal

REPO=
EDITOR=

case $1 in
  '-h'|'--help')
    usage;;
esac

[[ -z $1 ]] && usage

function do_defaults {
  [[ -z $EDITOR ]] && EDITOR=emacsxc
  [[ -z $REPO ]] && REPO=$WIKI/index.org
}

function wikicmd {
  REPO+="/$1"
}

function journalcmd {
  local yy= mm=

  while :; do
    if (( ${#1} != 4 )); then
      break
    fi

    yy=${1:0:2}
    mm=${1:2:2}

    [[ -d $REPO/20$yy/ ]]        || break
    [[ -f $REPO/20$yy/$mm.org ]] || break

    REPO+="/20$yy/$mm.org"

    return 0
  done

  echo "[ !! ] Command doesn't evaluate"
  exit 1
}

function handle {
  local repo=$1

  case $repo in
    'wiki')
      REPO=$WIKI;;
    'journal')
      REPO=$JOURNAL;;
  esac

  local _editor=false _cmd=false _cmd_chg=false

  for opt in ${@:1}; do
    if [[ $opt = '-c' ]]; then
      _editor=false
      _cmd=true
      continue
    elif [[ $opt = '-e' ]]; then
      _cmd=false
      _editor=true
      continue
    fi

    if $_editor; then
      EDITOR+=" $opt"
    elif $_cmd; then

      local cmd=$opt
      case $repo in
        'wiki')
          _cmd_chg=true
          wikicmd $cmd;;
        'journal')
          _cmd_chg=true
          journalcmd $cmd;;
      esac
    fi
  done

  if [[ -z $EDITOR ]]; then
    echo "[ !! ] Missing editor"
    exit 1
  elif ! $_cmd_chg; then
    REPO+="/index.org"
  fi
}

case $1 in
  'wiki')
    handle ${@:1};;
  'journal')
    handle ${@:1};;
  *)
    echo "[ !! ] Invalid entry"
    exit 1;;
esac

do_defaults

exec $EDITOR $REPO
